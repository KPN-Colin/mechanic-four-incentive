<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M4 Quiz</title>
<link rel="icon" href="/images/logo/m4-favicon.ico" sizes="any">
<link rel="icon" type="image/png" href="/images/logo/m4-icon.png">
<link rel="apple-touch-icon" href="/images/logo/m4-icon.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#00c300">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="mobile-web-app-capable" content="yes">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
html, body { height: 100%; overflow: hidden; }
html { background-color: #00c300; }
body { background-color: #fbfdfa; display: flex; flex-direction: column; }

header {
    background-color: #00c300; height: 70px; flex-shrink: 0;
    display: flex; align-items: center; padding: 0 20px; position: relative;
}
.back-button {
    background-color: #fff; color: #00c300; border: none; border-radius: 25px;
    padding: 7px 12px; cursor: pointer; font-weight: bold; font-size: 0.95rem;
}
.header-title {
    position: absolute; left: 50%; transform: translateX(-50%);
    color: #fff; font-size: 1.3rem; font-weight: bold;
}
.lb-btn {
    position: absolute; right: 15px;
    background-color: #fff; color: #00c300; border: none; border-radius: 20px;
    padding: 6px 12px; cursor: pointer; font-weight: bold; font-size: 0.8rem;
}

.content {
    flex: 1; display: flex; flex-direction: column; align-items: center;
    justify-content: center; padding: 20px; gap: 14px; overflow: hidden;
}
.score-bar { width: 100%; display: flex; justify-content: space-between; font-size: 0.9rem; color: #555; font-weight: bold; }
.progress-bar { width: 100%; height: 8px; background-color: #ddd; border-radius: 4px; overflow: hidden; }
.progress-fill { height: 100%; background-color: #00c300; border-radius: 4px; transition: width 0.4s ease; }

.speed-bar { width: 100%; height: 6px; background-color: #eee; border-radius: 3px; overflow: hidden; }
.speed-fill { height: 100%; background-color: #00c300; border-radius: 3px; transition: width 0.1s linear; }

.question-card {
    background-color: #fff; border-radius: 18px; padding: 22px 20px; width: 100%;
    text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    font-size: 1rem; font-weight: bold; color: #222; line-height: 1.4;
    min-height: 80px; display: flex; align-items: center; justify-content: center;
}
.answers { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; }
.answer-btn {
    background-color: #fff; border: 2px solid #ddd; border-radius: 12px;
    padding: 12px 10px; font-size: 0.85rem; font-weight: bold; color: #333;
    cursor: pointer; transition: 0.15s; text-align: center; line-height: 1.3;
}
.answer-btn.correct { background-color: #00c300; border-color: #00c300; color: #fff; }
.answer-btn.wrong   { background-color: #ff4444; border-color: #ff4444; color: #fff; }
.answer-btn:disabled { cursor: default; }
.feedback { font-size: 0.95rem; font-weight: bold; min-height: 22px; }

.result-screen { display: none; flex-direction: column; align-items: center; gap: 18px; text-align: center; }
.result-emoji { font-size: 4rem; }
.result-title { font-size: 1.5rem; font-weight: bold; color: #222; }
.result-score { font-size: 1rem; color: #555; }
.play-again-btn {
    padding: 13px 35px; background-color: #00c300; color: #fff; border: none;
    border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,195,0,0.3); margin: 4px;
}

.lb-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65);
    z-index: 100; align-items: center; justify-content: center;
}
.lb-overlay.show { display: flex; }
.lb-box {
    background: #fff; border-radius: 20px; padding: 25px 20px;
    width: 85vw; max-width: 340px; text-align: center;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
}
.lb-title { font-size: 1.3rem; font-weight: bold; color: #00a000; margin-bottom: 15px; }
.lb-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem;
}
.lb-item:last-child { border-bottom: none; }
.lb-rank { font-size: 1.3rem; width: 30px; text-align: center; }
.lb-name { flex: 1; font-weight: bold; color: #333; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.lb-score { font-weight: bold; color: #00c300; }
.lb-close {
    margin-top: 15px; padding: 10px 30px; background-color: #00c300; color: #fff;
    border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 0.9rem;
}
.lb-loading { color: #aaa; font-style: italic; padding: 20px; }

footer {
    background-color: #00c300; color: #fff; text-align: center;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem; flex-shrink: 0;
    padding-bottom: env(safe-area-inset-bottom, 0px);
    min-height: calc(55px + env(safe-area-inset-bottom, 0px));
}
</style>
</head>
<body>

<header>
    <button class="back-button" onclick="window.location.href='games.html'">&larr;</button>
    <div class="header-title">üß† M4 Quiz</div>
    <button class="lb-btn" onclick="toonLeaderboard()">üèÜ Top 5</button>
</header>

<div class="content" id="quizContent">
    <div class="score-bar">
        <span id="questionNum">Vraag 1 / 8</span>
        <span id="scoreDisplay">Score: 0</span>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    <div class="speed-bar"><div class="speed-fill" id="speedFill" style="width:100%"></div></div>
    <div class="question-card" id="questionCard"></div>
    <div class="answers" id="answersGrid"></div>
    <div class="feedback" id="feedback"></div>
</div>

<div class="content result-screen" id="resultScreen">
    <div class="result-emoji" id="resultEmoji"></div>
    <div class="result-title" id="resultTitle"></div>
    <div class="result-score" id="resultScore"></div>
    <button class="play-again-btn" onclick="startQuiz()">Opnieuw spelen</button>
    <button class="play-again-btn" style="background:#555" onclick="window.location.href='games.html'">Terug naar Games</button>
</div>

<div class="lb-overlay" id="lbOverlay">
    <div class="lb-box">
        <div class="lb-title">üèÜ Top 5 ‚Äî M4 Quiz</div>
        <div id="lbContent"><div class="lb-loading">Laden...</div></div>
        <button class="lb-close" onclick="sluitLeaderboard()">Sluiten</button>
    </div>
</div>

<footer>&copy; KPN 2026</footer>

<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(e => console.log('SW:', e));
}

const AT_KEY   = 'JOUW_AIRTABLE_API_KEY';
const AT_BASE  = 'JOUW_BASE_ID';
const AT_LB    = 'Leaderboard';
const SPEL     = 'quiz';
const LB_URL   = `https://api.airtable.com/v0/${AT_BASE}/${AT_LB}`;
const AT_HDR   = { 'Authorization': `Bearer ${AT_KEY}`, 'Content-Type': 'application/json' };

function getMSALUser() {
    try {
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (!key) continue;
            try {
                const val = JSON.parse(localStorage.getItem(key));
                if (val && val.username && val.username.includes('@kpn.com')) {
                    return { email: val.username, naam: val.name || val.username.split('@')[0] };
                }
            } catch(e) {}
        }
    } catch(e) {}
    return { email: 'onbekend@kpn.com', naam: 'Onbekend' };
}

async function slaScoreOp(score) {
    const user = getMSALUser();
    try {
        const params = new URLSearchParams({ filterByFormula: `AND({email}="${user.email}", {spel}="${SPEL}")` });
        const res  = await fetch(`${LB_URL}?${params}`, { headers: AT_HDR });
        const data = await res.json();
        if (data.records && data.records.length > 0) {
            const record = data.records[0];
            if (score > (record.fields.score || 0)) {
                await fetch(`${LB_URL}/${record.id}`, {
                    method: 'PATCH', headers: AT_HDR,
                    body: JSON.stringify({ fields: { score, naam: user.naam } })
                });
            }
        } else {
            await fetch(LB_URL, {
                method: 'POST', headers: AT_HDR,
                body: JSON.stringify({ records: [{ fields: { naam: user.naam, email: user.email, spel: SPEL, score } }] })
            });
        }
    } catch(e) { console.log('Score opslaan mislukt:', e); }
}

async function toonLeaderboard() {
    document.getElementById('lbOverlay').classList.add('show');
    document.getElementById('lbContent').innerHTML = '<div class="lb-loading">Laden...</div>';
    try {
        const params = new URLSearchParams({
            filterByFormula: `{spel}="${SPEL}"`,
            'sort[0][field]': 'score', 'sort[0][direction]': 'desc', maxRecords: 5
        });
        const res  = await fetch(`${LB_URL}?${params}`, { headers: AT_HDR });
        const data = await res.json();
        const medailles = ['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£'];
        if (!data.records || data.records.length === 0) {
            document.getElementById('lbContent').innerHTML = '<div class="lb-loading">Nog geen scores!</div>';
            return;
        }
        document.getElementById('lbContent').innerHTML = data.records.map((r, i) => `
            <div class="lb-item">
                <div class="lb-rank">${medailles[i]}</div>
                <div class="lb-name">${r.fields.naam || 'Onbekend'}</div>
                <div class="lb-score">${r.fields.score} pts</div>
            </div>`).join('');
    } catch(e) {
        document.getElementById('lbContent').innerHTML = '<div class="lb-loading">Fout bij laden.</div>';
    }
}

function sluitLeaderboard() { document.getElementById('lbOverlay').classList.remove('show'); }

const vragen = [
    { vraag: "Wat staat KPN voor?", antwoorden: ["Koninklijke PTT Nederland","Klanten Primair Netwerk","KPN Persoonlijk Netwerk","Koninklijk Post Netwerk"], goed: 0 },
    { vraag: "Welk product biedt KPN aan voor thuis internet?", antwoorden: ["4G Router","Glasvezel","Satelliet","Kabel"], goed: 1 },
    { vraag: "Wat is de KPN huiskleur?", antwoorden: ["Blauw","Rood","Groen","Oranje"], goed: 2 },
    { vraag: "Welke dienst biedt KPN aan voor zakelijke klanten?", antwoorden: ["KPN Zakelijk","KPN Office","KPN Business Plus","KPN Pro"], goed: 0 },
    { vraag: "Wat betekent 5G?", antwoorden: ["5 Gigabyte","5e Generatie mobiel netwerk","5 Gigahertz","5 Gelijktijdige verbindingen"], goed: 1 },
    { vraag: "Wat is een belangrijk voordeel van glasvezel?", antwoorden: ["Goedkoper dan 4G","Werkt zonder stroom","Hoge snelheid en stabiele verbinding","Geen installatie nodig"], goed: 2 },
    { vraag: "Wat is de naam van de KPN klantenservice app?", antwoorden: ["KPN Connect","Mijn KPN","KPN Direct","KPN Go"], goed: 1 },
    { vraag: "Welke generatie netwerk gebruiken de meeste smartphones nu?", antwoorden: ["3G","4G","5G","2G"], goed: 2 }
];

const VRAAG_TIJD = 12;
let huidigIndex = 0, score = 0, beantwoord = false;
let snelheidInterval, snelheidStart;

function startQuiz() {
    huidigIndex = 0; score = 0; beantwoord = false;
    document.getElementById('quizContent').style.display = 'flex';
    document.getElementById('resultScreen').style.display = 'none';
    laadVraag();
}

function laadVraag() {
    beantwoord = false;
    clearInterval(snelheidInterval);
    snelheidStart = Date.now();

    const v = vragen[huidigIndex];
    document.getElementById('questionNum').textContent  = `Vraag ${huidigIndex + 1} / ${vragen.length}`;
    document.getElementById('scoreDisplay').textContent = `Score: ${score}`;
    document.getElementById('progressFill').style.width = `${(huidigIndex / vragen.length) * 100}%`;
    document.getElementById('questionCard').textContent = v.vraag;
    document.getElementById('feedback').textContent     = '';
    document.getElementById('speedFill').style.width    = '100%';
    document.getElementById('speedFill').style.backgroundColor = '#00c300';

    snelheidInterval = setInterval(() => {
        const verstreken = (Date.now() - snelheidStart) / 1000;
        const pct = Math.max(0, 100 - (verstreken / VRAAG_TIJD) * 100);
        document.getElementById('speedFill').style.width = pct + '%';
        if (pct < 30) document.getElementById('speedFill').style.backgroundColor = '#ff4444';
        else if (pct < 60) document.getElementById('speedFill').style.backgroundColor = '#ffaa00';
        if (pct <= 0) { clearInterval(snelheidInterval); if (!beantwoord) tijdOp(); }
    }, 100);

    const grid = document.getElementById('answersGrid');
    grid.innerHTML = '';
    v.antwoorden.forEach((ant, i) => {
        const btn = document.createElement('button');
        btn.className = 'answer-btn';
        btn.textContent = ant;
        btn.onclick = () => checkAntwoord(i, btn);
        grid.appendChild(btn);
    });
}

function tijdOp() {
    beantwoord = true;
    clearInterval(snelheidInterval);
    const btns = document.querySelectorAll('.answer-btn');
    btns.forEach(b => b.disabled = true);
    btns[vragen[huidigIndex].goed].classList.add('correct');
    document.getElementById('feedback').textContent = '‚è∞ Te laat!';
    document.getElementById('feedback').style.color = '#ff4444';
    setTimeout(() => { huidigIndex++; huidigIndex < vragen.length ? laadVraag() : toonResultaat(); }, 1400);
}

function checkAntwoord(index, btn) {
    if (beantwoord) return;
    beantwoord = true;
    clearInterval(snelheidInterval);

    const verstreken = (Date.now() - snelheidStart) / 1000;
    const v = vragen[huidigIndex];
    const btns = document.querySelectorAll('.answer-btn');
    btns.forEach(b => b.disabled = true);

    if (index === v.goed) {
        btn.classList.add('correct');
        let punten = 10;
        let bonusTekst = '';
        if (verstreken < 3)       { punten += 5; bonusTekst = ' +5 snel!'; }
        else if (verstreken < 6)  { punten += 3; bonusTekst = ' +3 snel!'; }
        else if (verstreken < 10) { punten += 1; bonusTekst = ' +1 snel!'; }
        score += punten;
        document.getElementById('feedback').textContent = `‚úÖ Goed! +${punten} pts${bonusTekst}`;
        document.getElementById('feedback').style.color = '#00a000';
    } else {
        btn.classList.add('wrong');
        btns[v.goed].classList.add('correct');
        document.getElementById('feedback').textContent = '‚ùå Helaas!';
        document.getElementById('feedback').style.color = '#ff4444';
    }

    document.getElementById('scoreDisplay').textContent = `Score: ${score}`;
    setTimeout(() => { huidigIndex++; huidigIndex < vragen.length ? laadVraag() : toonResultaat(); }, 1400);
}

function toonResultaat() {
    clearInterval(snelheidInterval);
    document.getElementById('quizContent').style.display = 'none';
    document.getElementById('resultScreen').style.display = 'flex';

    const max = vragen.length * 15;
    const pct = score / max;
    let emoji, titel;
    if (pct >= 0.9)      { emoji = 'üèÜ'; titel = 'Ongelooflijk!'; }
    else if (pct >= 0.7) { emoji = 'üéâ'; titel = 'Heel goed!'; }
    else if (pct >= 0.5) { emoji = 'üëç'; titel = 'Niet slecht!'; }
    else                 { emoji = 'üìö'; titel = 'Nog wat oefenen...'; }

    document.getElementById('resultEmoji').textContent = emoji;
    document.getElementById('resultTitle').textContent = titel;
    document.getElementById('resultScore').textContent = `Jouw score: ${score} punten (max ${max})`;
    slaScoreOp(score);
}

startQuiz();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tik de Mechanic</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
html, body { height: 100%; overflow: hidden; }
body { background-color: #fbfdfa; display: flex; flex-direction: column; }

header {
    background-color: #00c300; height: 70px; flex-shrink: 0;
    display: flex; align-items: center; padding: 0 20px; position: relative;
}
.back-button {
    background-color: #fff; color: #00c300; border: none; border-radius: 25px;
    padding: 7px 12px; cursor: pointer; font-weight: bold; font-size: 0.95rem;
}
.header-title {
    position: absolute; left: 50%; transform: translateX(-50%);
    color: #fff; font-size: 1.2rem; font-weight: bold; white-space: nowrap;
}
.lb-btn {
    position: absolute; right: 15px; background-color: #fff; color: #00c300;
    border: none; border-radius: 20px; padding: 6px 12px;
    cursor: pointer; font-weight: bold; font-size: 0.8rem;
}

.stats {
    flex-shrink: 0; display: flex; justify-content: space-around;
    padding: 8px 20px; font-size: 0.9rem; font-weight: bold; color: #555;
}
.timer-bar { flex-shrink: 0; height: 8px; background-color: #ddd; margin: 0 20px; border-radius: 4px; overflow: hidden; }
.timer-fill { height: 100%; background-color: #00c300; border-radius: 4px; transition: width 0.1s linear, background-color 0.3s; }

.speelveld {
    flex: 1; position: relative; overflow: hidden;
    margin: 10px; background-color: #eae9ec; border-radius: 18px;
}

.mechanic {
    position: absolute; font-size: 3rem; cursor: pointer; user-select: none;
    filter: drop-shadow(2px 3px 4px rgba(0,0,0,0.2));
    animation: popin 0.15s ease;
    transition: opacity 0.15s, transform 0.15s;
}
@keyframes popin {
    from { transform: scale(0.2); opacity: 0; }
    to   { transform: scale(1);   opacity: 1; }
}
.mechanic.verdwijn { opacity: 0; transform: scale(0.2); }

.hit-effect {
    position: absolute; font-size: 1.3rem; font-weight: bold; color: #00c300;
    pointer-events: none; animation: floatUp 0.6s ease forwards; z-index: 10;
}
@keyframes floatUp {
    from { opacity: 1; transform: translateY(0); }
    to   { opacity: 0; transform: translateY(-45px); }
}

.start-overlay, .end-overlay {
    position: absolute; inset: 0; display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 14px; text-align: center;
    background-color: rgba(234,233,236,0.95); border-radius: 18px; z-index: 20;
}
.overlay-emoji { font-size: 3.5rem; }
.overlay-title { font-size: 1.4rem; font-weight: bold; color: #222; }
.overlay-sub   { font-size: 0.88rem; color: #666; line-height: 1.5; padding: 0 20px; }
.start-btn {
    padding: 13px 38px; background-color: #00c300; color: #fff; border: none;
    border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,195,0,0.3); margin: 4px;
}

/* LEADERBOARD */
.lb-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 100; align-items: center; justify-content: center; }
.lb-overlay.show { display: flex; }
.lb-box { background: #fff; border-radius: 20px; padding: 25px 20px; width: 85vw; max-width: 340px; text-align: center; box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
.lb-title { font-size: 1.3rem; font-weight: bold; color: #00a000; margin-bottom: 15px; }
.lb-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
.lb-item:last-child { border-bottom: none; }
.lb-rank { font-size: 1.3rem; width: 30px; text-align: center; }
.lb-name { flex: 1; font-weight: bold; color: #333; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.lb-score { font-weight: bold; color: #00c300; }
.lb-close { margin-top: 15px; padding: 10px 30px; background-color: #00c300; color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
.lb-loading { color: #aaa; font-style: italic; padding: 20px; }

footer { background-color: #00c300; color: #fff; text-align: center; height: 55px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
</style>
</head>
<body>

<header>
    <button class="back-button" onclick="window.location.href='games.html'">&larr;</button>
    <div class="header-title">üëä Tik de Mechanic</div>
    <button class="lb-btn" onclick="toonLeaderboard()">üèÜ Top 5</button>
</header>

<div class="stats">
    <span>Score: <strong id="score">0</strong></span>
    <span>Gemist: <strong id="gemist">0</strong> / 3</span>
</div>
<div class="timer-bar"><div class="timer-fill" id="timerFill" style="width:100%"></div></div>

<div class="speelveld" id="speelveld">
    <div class="start-overlay" id="startOverlay">
        <div class="overlay-emoji">üëä</div>
        <div class="overlay-title">Tik de Mechanic!</div>
        <div class="overlay-sub">Tik zo snel mogelijk op de mechanics.<br>Er kunnen 1 tot 3 tegelijk verschijnen.<br>3 keer missen = game over!</div>
        <button class="start-btn" onclick="startGame()">Spelen!</button>
    </div>
    <div class="end-overlay" id="endOverlay" style="display:none">
        <div class="overlay-emoji" id="endEmoji"></div>
        <div class="overlay-title" id="endTitle"></div>
        <div class="overlay-sub" id="endSub"></div>
        <button class="start-btn" onclick="startGame()">Opnieuw</button>
        <button class="start-btn" style="background:#555" onclick="window.location.href='games.html'">Terug</button>
    </div>
</div>

<div class="lb-overlay" id="lbOverlay">
    <div class="lb-box">
        <div class="lb-title">üèÜ Top 5 ‚Äî Tik de Mechanic</div>
        <div id="lbContent"><div class="lb-loading">Laden...</div></div>
        <button class="lb-close" onclick="sluitLeaderboard()">Sluiten</button>
    </div>
</div>

<footer>&copy; KPN 2026</footer>

<script>
const AT_KEY  = 'JOUW_AIRTABLE_API_KEY';
const AT_BASE = 'JOUW_BASE_ID';
const AT_LB   = 'Leaderboard';
const SPEL    = 'tiktak';
const LB_URL  = `https://api.airtable.com/v0/${AT_BASE}/${AT_LB}`;
const AT_HDR  = { 'Authorization': `Bearer ${AT_KEY}`, 'Content-Type': 'application/json' };

function getMSALUser() {
    try {
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (!key) continue;
            try {
                const val = JSON.parse(localStorage.getItem(key));
                if (val && val.username && val.username.includes('@kpn.com')) {
                    return { email: val.username, naam: val.name || val.username.split('@')[0] };
                }
            } catch(e) {}
        }
    } catch(e) {}
    return { email: 'onbekend@kpn.com', naam: 'Onbekend' };
}

async function slaScoreOp(score) {
    const user = getMSALUser();
    try {
        const params = new URLSearchParams({ filterByFormula: `AND({email}="${user.email}", {spel}="${SPEL}")` });
        const res  = await fetch(`${LB_URL}?${params}`, { headers: AT_HDR });
        const data = await res.json();
        if (data.records && data.records.length > 0) {
            const record = data.records[0];
            if (score > (record.fields.score || 0)) {
                await fetch(`${LB_URL}/${record.id}`, { method: 'PATCH', headers: AT_HDR, body: JSON.stringify({ fields: { score, naam: user.naam } }) });
            }
        } else {
            await fetch(LB_URL, { method: 'POST', headers: AT_HDR, body: JSON.stringify({ records: [{ fields: { naam: user.naam, email: user.email, spel: SPEL, score } }] }) });
        }
    } catch(e) {}
}

async function toonLeaderboard() {
    document.getElementById('lbOverlay').classList.add('show');
    document.getElementById('lbContent').innerHTML = '<div class="lb-loading">Laden...</div>';
    try {
        const params = new URLSearchParams({ filterByFormula: `{spel}="${SPEL}"`, 'sort[0][field]': 'score', 'sort[0][direction]': 'desc', maxRecords: 5 });
        const res  = await fetch(`${LB_URL}?${params}`, { headers: AT_HDR });
        const data = await res.json();
        const medailles = ['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£'];
        if (!data.records || data.records.length === 0) { document.getElementById('lbContent').innerHTML = '<div class="lb-loading">Nog geen scores!</div>'; return; }
        document.getElementById('lbContent').innerHTML = data.records.map((r, i) => `<div class="lb-item"><div class="lb-rank">${medailles[i]}</div><div class="lb-name">${r.fields.naam || 'Onbekend'}</div><div class="lb-score">${r.fields.score} pts</div></div>`).join('');
    } catch(e) { document.getElementById('lbContent').innerHTML = '<div class="lb-loading">Fout bij laden.</div>'; }
}

function sluitLeaderboard() { document.getElementById('lbOverlay').classList.remove('show'); }

// ‚îÄ‚îÄ TIKTAK LOGICA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const emojis = ['üîß','üì±','üì°','üíª','‚òéÔ∏è','üåê'];
let score = 0, gemist = 0, actieveMechanics = 0, timerInterval, spawnTimeout;
let spelBezig = false;
const MAX_GEMIST = 3, SPEEL_TIJD = 30, MAX_TEGELIJK = 3;
let tijdResterend = SPEEL_TIJD;

function startGame() {
    score = 0; gemist = 0; tijdResterend = SPEEL_TIJD; actieveMechanics = 0;
    spelBezig = true;
    document.getElementById('score').textContent  = '0';
    document.getElementById('gemist').textContent = '0';
    document.getElementById('timerFill').style.width           = '100%';
    document.getElementById('timerFill').style.backgroundColor = '#00c300';
    document.getElementById('startOverlay').style.display = 'none';
    document.getElementById('endOverlay').style.display   = 'none';
    document.querySelectorAll('.mechanic').forEach(m => m.remove());

    clearInterval(timerInterval);
    clearTimeout(spawnTimeout);

    timerInterval = setInterval(() => {
        tijdResterend -= 0.1;
        const pct = (tijdResterend / SPEEL_TIJD) * 100;
        document.getElementById('timerFill').style.width = Math.max(0, pct) + '%';
        if (pct < 30) document.getElementById('timerFill').style.backgroundColor = '#ff4444';
        else if (pct < 60) document.getElementById('timerFill').style.backgroundColor = '#ffaa00';
        if (tijdResterend <= 0) eindSpel('tijd');
    }, 100);

    planSpawn();
}

function planSpawn() {
    if (!spelBezig) return;

    // Spawn 1 tot 3 mechanics tegelijk, random
    const aantalTeSpawnen = Math.floor(Math.random() * 3) + 1; // 1, 2 of 3
    const beschikbaar = MAX_TEGELIJK - actieveMechanics;
    const spawn = Math.min(aantalTeSpawnen, beschikbaar);

    for (let i = 0; i < spawn; i++) {
        setTimeout(() => spawnMechanic(), i * 150);
    }

    // Volgende spawn over 400-800ms (sneller dan voorheen)
    const wachttijd = 400 + Math.random() * 400;
    spawnTimeout = setTimeout(planSpawn, wachttijd);
}

function spawnMechanic() {
    if (!spelBezig || actieveMechanics >= MAX_TEGELIJK) return;

    const veld = document.getElementById('speelveld');
    const W = veld.offsetWidth, H = veld.offsetHeight;

    const mech = document.createElement('div');
    mech.className = 'mechanic';
    mech.textContent = emojis[Math.floor(Math.random() * emojis.length)];

    const x = 15 + Math.random() * (W - 85);
    const y = 15 + Math.random() * (H - 85);
    mech.style.left = x + 'px';
    mech.style.top  = y + 'px';

    // Leefijd: 900-1400ms (korter = moeilijker)
    const leefTijd = 900 + Math.random() * 500;
    actieveMechanics++;

    mech.onclick = (e) => {
        e.stopPropagation();
        if (!spelBezig || mech.classList.contains('verdwijn')) return;
        score++;
        document.getElementById('score').textContent = score;
        showHit(x + 30, y, '+1');
        verwijderMechanic(mech);
    };

    veld.appendChild(mech);

    setTimeout(() => {
        if (mech.parentElement && !mech.classList.contains('verdwijn')) {
            gemist++;
            document.getElementById('gemist').textContent = gemist;
            verwijderMechanic(mech);
            if (gemist >= MAX_GEMIST) eindSpel('gemist');
        }
    }, leefTijd);
}

function verwijderMechanic(mech) {
    mech.classList.add('verdwijn');
    actieveMechanics = Math.max(0, actieveMechanics - 1);
    setTimeout(() => { if (mech.parentElement) mech.remove(); }, 200);
}

function showHit(x, y, tekst) {
    const veld = document.getElementById('speelveld');
    const el = document.createElement('div');
    el.className = 'hit-effect';
    el.textContent = tekst;
    el.style.left = x + 'px';
    el.style.top  = y + 'px';
    veld.appendChild(el);
    setTimeout(() => el.remove(), 600);
}

function eindSpel(reden) {
    if (!spelBezig) return;
    spelBezig = false;
    clearInterval(timerInterval);
    clearTimeout(spawnTimeout);
    document.querySelectorAll('.mechanic').forEach(m => m.remove());

    let emoji, titel, sub;
    if (reden === 'tijd') {
        if (score >= 25)      { emoji = 'üèÜ'; titel = 'Waanzinnig!'; }
        else if (score >= 15) { emoji = 'üéâ'; titel = 'Goed gedaan!'; }
        else                  { emoji = 'üëç'; titel = 'Niet slecht!'; }
        sub = `Je tikte ${score} mechanics in ${SPEEL_TIJD} seconden!`;
    } else {
        emoji = 'üòÖ'; titel = '3x gemist!';
        sub = `Je tikte ${score} mechanics voordat je 3x miste.`;
    }

    document.getElementById('endEmoji').textContent = emoji;
    document.getElementById('endTitle').textContent = titel;
    document.getElementById('endSub').textContent   = sub;
    document.getElementById('endOverlay').style.display = 'flex';

    slaScoreOp(score);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Woordraad</title>
<link rel="icon" href="/images/logo/m4-favicon.ico" sizes="any">
<link rel="icon" type="image/png" href="/images/logo/m4-icon.png">
<link rel="apple-touch-icon" href="/images/logo/m4-icon.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#00c300">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="mobile-web-app-capable" content="yes">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
html, body { height: 100%; overflow: hidden; }
html { background-color: #00c300; }
body { background-color: #fbfdfa; display: flex; flex-direction: column; }

header {
    background-color: #00c300; height: 70px; flex-shrink: 0;
    display: flex; align-items: center; padding: 0 20px; position: relative;
}
.back-button {
    background-color: #fff; color: #00c300; border: none; border-radius: 25px;
    padding: 7px 12px; cursor: pointer; font-weight: bold; font-size: 0.95rem;
}
.header-title {
    position: absolute; left: 50%; transform: translateX(-50%);
    color: #fff; font-size: 1.3rem; font-weight: bold;
}
.lb-btn {
    position: absolute; right: 15px; background-color: #fff; color: #00c300;
    border: none; border-radius: 20px; padding: 6px 12px;
    cursor: pointer; font-weight: bold; font-size: 0.8rem;
}

.hint { text-align: center; padding: 8px; font-size: 0.82rem; color: #666; font-style: italic; flex-shrink: 0; }

.raster {
    flex-shrink: 0; display: flex; flex-direction: column;
    align-items: center; gap: 4px; padding: 4px 10px;
}
.rij { display: flex; gap: 4px; }
.cel {
    width: 44px; height: 44px; border: 2px solid #ccc; border-radius: 7px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem; font-weight: bold; color: #222; background-color: #fff;
    transition: background-color 0.3s, border-color 0.3s, color 0.3s;
}
.cel.goed   { background-color: #00c300; border-color: #00c300; color: #fff; }
.cel.bijna  { background-color: #ffaa00; border-color: #ffaa00; color: #fff; }
.cel.fout   { background-color: #888;    border-color: #888;    color: #fff; }
.cel.actief { border-color: #00c300; }

.keyboard { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; padding: 5px 8px; }
.toets-rij { display: flex; gap: 4px; }
.toets {
    min-width: 28px; height: 40px; padding: 0 4px; border: none; border-radius: 6px;
    background-color: #ddd; font-size: 0.75rem; font-weight: bold; color: #222; cursor: pointer;
}
.toets:active { transform: scale(0.95); }
.toets.breed  { min-width: 46px; font-size: 0.68rem; }
.toets.goed   { background-color: #00c300; color: #fff; }
.toets.bijna  { background-color: #ffaa00; color: #fff; }
.toets.fout   { background-color: #888;    color: #fff; }

.feedback { text-align: center; font-size: 0.88rem; font-weight: bold; min-height: 20px; color: #333; flex-shrink: 0; padding: 3px 10px; }

.win-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6);
    z-index: 50; align-items: center; justify-content: center;
    flex-direction: column; gap: 14px; text-align: center; color: #fff;
}
.win-overlay.show { display: flex; }
.win-emoji  { font-size: 3.5rem; }
.win-title  { font-size: 1.5rem; font-weight: bold; }
.win-woord  { font-size: 1.6rem; font-weight: bold; background: #00c300; padding: 8px 20px; border-radius: 10px; }
.win-sub    { font-size: 0.95rem; opacity: 0.9; }
.win-btn    { padding: 13px 32px; background-color: #00c300; color: #fff; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; margin: 4px; }

.lb-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.65); z-index: 100; align-items: center; justify-content: center; }
.lb-overlay.show { display: flex; }
.lb-box { background: #fff; border-radius: 20px; padding: 25px 20px; width: 85vw; max-width: 340px; text-align: center; box-shadow: 0 8px 30px rgba(0,0,0,0.3); }
.lb-title { font-size: 1.3rem; font-weight: bold; color: #00a000; margin-bottom: 15px; }
.lb-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 0.9rem; }
.lb-item:last-child { border-bottom: none; }
.lb-rank { font-size: 1.3rem; width: 30px; text-align: center; }
.lb-name { flex: 1; font-weight: bold; color: #333; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.lb-score { font-weight: bold; color: #00c300; }
.lb-close { margin-top: 15px; padding: 10px 30px; background-color: #00c300; color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
.lb-loading { color: #aaa; font-style: italic; padding: 20px; }

footer {
    background-color: #00c300; color: #fff; text-align: center;
    display: flex; align-items: center; justify-content: center;
    font-size: 1rem; flex-shrink: 0;
    padding-bottom: env(safe-area-inset-bottom, 0px);
    min-height: calc(55px + env(safe-area-inset-bottom, 0px));
}
</style>
</head>
<body>

<header>
    <button class="back-button" onclick="window.location.href='games.html'">&larr;</button>
    <div class="header-title">üî§ Woordraad</div>
    <button class="lb-btn" onclick="toonLeaderboard()">üèÜ Top 5</button>
</header>

<div class="hint" id="hintTekst"></div>
<div class="raster" id="raster"></div>
<div class="feedback" id="feedback"></div>
<div class="keyboard" id="keyboard"></div>

<div class="win-overlay" id="winOverlay">
    <div class="win-emoji" id="winEmoji"></div>
    <div class="win-title" id="winTitle"></div>
    <div class="win-woord" id="winWoord"></div>
    <div class="win-sub" id="winSub"></div>
    <div>
        <button class="win-btn" onclick="startGame()">Nieuw woord</button>
        <button class="win-btn" style="background:#555" onclick="window.location.href='games.html'">Terug</button>
    </div>
</div>

<div class="lb-overlay" id="lbOverlay">
    <div class="lb-box">
        <div class="lb-title">üèÜ Top 5 ‚Äî Woordraad</div>
        <div id="lbContent"><div class="lb-loading">Laden...</div></div>
        <button class="lb-close" onclick="sluitLeaderboard()">Sluiten</button>
    </div>
</div>

<footer>&copy; KPN 2026</footer>

<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(e => console.log('SW:', e));
}

const AT_KEY  = 'JOUW_AIRTABLE_API_KEY';
const AT_BASE = 'JOUW_BASE_ID';
const AT_LB   = 'Leaderboard';
const SPEL    = 'woordraad';
const LB_URL  = `https://api.airtable.com/v0/${AT_BASE}/${AT_LB}`;
const AT_HDR  = { 'Authorization': `Bearer ${AT_KEY}`, 'Content-Type': 'application/json' };

function getMSALUser() {
    try {
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (!key) continue;
            try {
                const val = JSON.parse(localStorage.getItem(key));
                if (val && val.username && val.username.includes('@kpn.com')) {
                    return { email: val.username, naam: val.name || val.username.split('@')[0] };
                }
            } catch(e) {}
        }
    } catch(e) {}
    return { email: 'onbekend@kpn.com', naam: 'Onbekend' };
}

async function slaScoreOp(score) {
    const user = getMSALUser();
    try {
        const params = new URLSearchParams({ filterByFormula: `AND({email}="${user.email}", {spel}="${SPEL}")` });
        const res  = await fetch(`${LB_URL}?${params}`, { headers: AT_HDR });
        const data = await res.json();
        if (data.records && data.records.length > 0) {
            const record = data.records[0];
            if (score > (record.fields.score || 0)) {
                await fetch(`${LB_URL}/${record.id}`, { method: 'PATCH', headers: AT_HDR, body: JSON.stringify({ fields: { score, naam: user.naam } }) });
            }
        } else {
            await fetch(LB_URL, { method: 'POST', headers: AT_HDR, body: JSON.stringify({ records: [{ fields: { naam: user.naam, email: user.email, spel: SPEL, score } }] }) });
        }
    } catch(e) {}
}

async function toonLeaderboard() {
    document.getElementById('lbOverlay').classList.add('show');
    document.getElementById('lbContent').innerHTML = '<div class="lb-loading">Laden...</div>';
    try {
        const params = new URLSearchParams({ filterByFormula: `{spel}="${SPEL}"`, 'sort[0][field]': 'score', 'sort[0][direction]': 'desc', maxRecords: 5 });
        const res  = await fetch(`${LB_URL}?${params}`, { headers: AT_HDR });
        const data = await res.json();
        const medailles = ['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£'];
        if (!data.records || data.records.length === 0) { document.getElementById('lbContent').innerHTML = '<div class="lb-loading">Nog geen scores!</div>'; return; }
        document.getElementById('lbContent').innerHTML = data.records.map((r, i) => `<div class="lb-item"><div class="lb-rank">${medailles[i]}</div><div class="lb-name">${r.fields.naam || 'Onbekend'}</div><div class="lb-score">${r.fields.score} pts</div></div>`).join('');
    } catch(e) { document.getElementById('lbContent').innerHTML = '<div class="lb-loading">Fout bij laden.</div>'; }
}

function sluitLeaderboard() { document.getElementById('lbOverlay').classList.remove('show'); }

const woordenlijst = [
    { woord: 'MOBIEL',     hint: 'üì± Je draagt het altijd bij je' },
    { woord: 'NETWERK',    hint: 'üì° Verbindt alles met alles' },
    { woord: 'ROUTER',     hint: 'üì∂ Verdeelt je wifi signaal' },
    { woord: 'SIMKAART',   hint: 'üì≤ Zit in je telefoon' },
    { woord: 'BEREIK',     hint: 'üì° Heb je dit in de kelder?' },
    { woord: 'HOTSPOT',    hint: 'üî• Deel je internet via je telefoon' },
    { woord: 'ABONNEMENT', hint: 'üìã Maandelijks betaal je dit' },
    { woord: 'DATABUNDEL', hint: 'üìä Hoeveel MB heb jij nog?' },
    { woord: 'BELMINUTEN', hint: '‚òéÔ∏è Hoe lang mag je bellen?' },
    { woord: 'GLASVEZEL',  hint: 'üåê Snel internet thuis' },
];

const MAX_POGINGEN = 6;
let huidigWoord, hint, huidigPoging, huidigLetter, cellen, toetsenStatus, bezig;

function startGame() {
    document.getElementById('winOverlay').classList.remove('show');
    const keuze = woordenlijst[Math.floor(Math.random() * woordenlijst.length)];
    huidigWoord  = keuze.woord;
    hint         = keuze.hint;
    huidigPoging = 0; huidigLetter = 0; bezig = true; toetsenStatus = {};
    document.getElementById('hintTekst').textContent = `üí° Hint: ${hint}`;
    document.getElementById('feedback').textContent  = '';
    bouwRaster();
    bouwToetsenbord();
}

function bouwRaster() {
    const raster = document.getElementById('raster');
    raster.innerHTML = '';
    cellen = [];
    for (let r = 0; r < MAX_POGINGEN; r++) {
        const rij = document.createElement('div');
        rij.className = 'rij';
        const rijCellen = [];
        for (let k = 0; k < huidigWoord.length; k++) {
            const cel = document.createElement('div');
            cel.className = 'cel' + (r === 0 ? ' actief' : '');
            rij.appendChild(cel);
            rijCellen.push(cel);
        }
        cellen.push(rijCellen);
        raster.appendChild(rij);
    }
}

function bouwToetsenbord() {
    const kb = document.getElementById('keyboard');
    kb.innerHTML = '';
    const rijen = [
        ['Q','W','E','R','T','Y','U','I','O','P'],
        ['A','S','D','F','G','H','J','K','L'],
        ['ENTER','Z','X','C','V','B','N','M','‚å´']
    ];
    rijen.forEach(rij => {
        const rijEl = document.createElement('div');
        rijEl.className = 'toets-rij';
        rij.forEach(letter => {
            const btn = document.createElement('button');
            btn.className = 'toets' + (letter.length > 1 ? ' breed' : '');
            btn.textContent = letter;
            btn.id = 'toets-' + letter;
            btn.onclick = () => invoer(letter);
            rijEl.appendChild(btn);
        });
        kb.appendChild(rijEl);
    });
}

function invoer(letter) {
    if (!bezig) return;
    if (letter === '‚å´') { if (huidigLetter > 0) { huidigLetter--; cellen[huidigPoging][huidigLetter].textContent = ''; } return; }
    if (letter === 'ENTER') { controleer(); return; }
    if (huidigLetter < huidigWoord.length) { cellen[huidigPoging][huidigLetter].textContent = letter; huidigLetter++; }
}

function controleer() {
    if (huidigLetter < huidigWoord.length) {
        document.getElementById('feedback').textContent = `Vul alle ${huidigWoord.length} letters in!`;
        return;
    }
    document.getElementById('feedback').textContent = '';
    const ingevoerd = cellen[huidigPoging].map(c => c.textContent).join('');
    const woordArr  = huidigWoord.split('');
    const resultaat = Array(huidigWoord.length).fill('fout');
    const woordRest = [...woordArr];

    for (let i = 0; i < huidigWoord.length; i++) {
        if (ingevoerd[i] === woordArr[i]) { resultaat[i] = 'goed'; woordRest[i] = null; }
    }
    for (let i = 0; i < huidigWoord.length; i++) {
        if (resultaat[i] === 'goed') continue;
        const idx = woordRest.indexOf(ingevoerd[i]);
        if (idx !== -1) { resultaat[i] = 'bijna'; woordRest[idx] = null; }
    }

    resultaat.forEach((res, i) => {
        setTimeout(() => {
            const cel = cellen[huidigPoging][i];
            cel.classList.remove('actief');
            cel.classList.add(res);
            const letter = ingevoerd[i];
            const prioriteit = { 'goed': 3, 'bijna': 2, 'fout': 1 };
            const huidig = toetsenStatus[letter] || 'geen';
            if ((prioriteit[res] || 0) > (prioriteit[huidig] || 0)) {
                toetsenStatus[letter] = res;
                const toets = document.getElementById('toets-' + letter);
                if (toets) { toets.classList.remove('goed','bijna','fout'); toets.classList.add(res); }
            }
        }, i * 120);
    });

    const gewonnen = ingevoerd === huidigWoord;
    setTimeout(() => {
        if (gewonnen) {
            bezig = false;
            const pogingen = huidigPoging + 1;
            let punten;
            if (pogingen === 1)      punten = 5;
            else if (pogingen === 2) punten = 3;
            else if (pogingen === 3) punten = 2;
            else                     punten = 1;

            document.getElementById('winEmoji').textContent = pogingen <= 2 ? 'üèÜ' : pogingen <= 4 ? 'üéâ' : 'üòÖ';
            document.getElementById('winTitle').textContent = pogingen <= 2 ? 'Ongelooflijk!' : pogingen <= 4 ? 'Goed gedaan!' : 'Net op tijd!';
            document.getElementById('winWoord').textContent = huidigWoord;
            document.getElementById('winSub').textContent   = `Geraden in ${pogingen} ${pogingen === 1 ? 'poging' : 'pogingen'} ‚Ä¢ ${punten} punt${punten !== 1 ? 'en' : ''}`;
            setTimeout(() => document.getElementById('winOverlay').classList.add('show'), 300);
            slaScoreOp(punten);
            return;
        }

        huidigPoging++;
        if (huidigPoging >= MAX_POGINGEN) {
            bezig = false;
            document.getElementById('winEmoji').textContent = 'üò¢';
            document.getElementById('winTitle').textContent = 'Helaas!';
            document.getElementById('winWoord').textContent = huidigWoord;
            document.getElementById('winSub').textContent   = 'Het woord was:';
            setTimeout(() => document.getElementById('winOverlay').classList.add('show'), 300);
            slaScoreOp(0);
            return;
        }

        huidigLetter = 0;
        cellen[huidigPoging].forEach(c => c.classList.add('actief'));
    }, huidigWoord.length * 120 + 200);
}

document.addEventListener('keydown', (e) => {
    if (!bezig) return;
    if (e.key === 'Backspace') invoer('‚å´');
    else if (e.key === 'Enter') invoer('ENTER');
    else if (/^[A-Za-z]$/.test(e.key)) invoer(e.key.toUpperCase());
});

startGame();
</script>
</body>
</html>

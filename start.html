<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Mechanic 4 - Test</title>
<meta name="theme-color" content="#00c300">

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; }

body {
    background-color: #eae9ec;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

header {
    background-color: #00c300;
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
}

header h1 {
    color: white;
    font-size: 1.5rem;
}

.middle-section {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.graffiti-container {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 3;
}

.graffiti-container svg * {
    fill: none !important;
}

.spray-streak {
    position: absolute;
    width: 3px;
    height: 8px;
    border-radius: 2px;
    z-index: 26;
    pointer-events: none;
    opacity: 0;
}

@keyframes spray-streak {
    0% { 
        opacity: 0.8; 
        transform: translate(0, 0) scale(1); 
    }
    100% { 
        opacity: 0; 
        transform: translate(var(--tx), var(--ty)) scale(0.5); 
    }
}

.spons {
    position: absolute;
    font-size: 6rem;
    z-index: 25;
    pointer-events: none;
    display: none;
    filter: drop-shadow(0 3px 6px rgba(0,0,0,0.25));
}

.wipe-overlay {
    position: absolute;
    background-color: #eae9ec;
    pointer-events: none;
    z-index: 24;
    display: none;
}

footer {
    background-color: #00c300;
    color: #fff;
    text-align: center;
    padding: 15px;
}
</style>
</head>

<body>

<header>
    <h1>Graffiti Test</h1>
</header>

<div class="middle-section">
    <div class="graffiti-container" id="graffitiContainer"></div>
    <div class="wipe-overlay" id="wipeOverlay"></div>
    <div class="spons" id="spons">ðŸ§½</div>
</div>

<footer>&copy; KPN 2026</footer>

<script>
const graffitiContainer = document.getElementById('graffitiContainer');
const spons = document.getElementById('spons');
const wipeOverlay = document.getElementById('wipeOverlay');

let sprayParticles = [];
let graffitiY = 0;
let graffitiHoogte = 0;

async function testGraffiti() {
    console.log('ðŸŽ¨ START TEST');
    
    const kleur = '#FF6B35'; // Oranje
    
    try {
        const response = await fetch('/fonts/winnen-winnen-winnen.svg');
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        let svgText = await response.text();
        
        // Verwijder fills
        svgText = svgText.replace(/fill="[^"]*"/gi, '');
        svgText = svgText.replace(/fill:[^;"]*;?/gi, '');
        
        graffitiContainer.innerHTML = svgText;
        await new Promise(r => requestAnimationFrame(r));
        
        const svg = graffitiContainer.querySelector('svg');
        if (!svg) throw new Error('Geen SVG');
        
        console.log('âœ… SVG geladen');
        
        // Converteer MM naar PX
        const MM_TO_PX = 3.779527559;
        
        let widthMM, heightMM;
        const widthAttr = svg.getAttribute('width');
        const heightAttr = svg.getAttribute('height');
        
        if (widthAttr && widthAttr.includes('mm')) {
            widthMM = parseFloat(widthAttr);
            heightMM = parseFloat(heightAttr);
        } else {
            const viewBox = svg.getAttribute('viewBox');
            if (viewBox) {
                const parts = viewBox.split(/\s+|,/);
                widthMM = parseFloat(parts[2]);
                heightMM = parseFloat(parts[3]);
            } else {
                widthMM = 100;
                heightMM = 20;
            }
        }
        
        const widthPX = widthMM * MM_TO_PX;
        const heightPX = heightMM * MM_TO_PX;
        
        svg.setAttribute('viewBox', `0 0 ${widthPX} ${heightPX}`);
        svg.setAttribute('width', widthPX);
        svg.setAttribute('height', heightPX);
        
        await new Promise(r => requestAnimationFrame(r));
        
        // Vind paths
        const alleElementen = svg.querySelectorAll('*');
        const paths = [];
        
        alleElementen.forEach(elem => {
            const tagName = elem.tagName.toLowerCase();
            
            if (!['path', 'line', 'polyline', 'polygon', 'g', 'svg'].includes(tagName)) {
                elem.remove();
                return;
            }
            
            elem.removeAttribute('fill');
            elem.style.fill = 'none';
            
            if (['path', 'line', 'polyline', 'polygon'].includes(tagName)) {
                try {
                    const length = elem.getTotalLength();
                    if (length > 0) {
                        paths.push({ path: elem, length });
                    }
                } catch (e) {}
            }
        });
        
        console.log('ðŸ›¤ï¸ Paths gevonden:', paths.length);
        
        if (paths.length === 0) throw new Error('Geen paths!');
        
        // Schaal naar 60% van scherm breedte
        const maxWidth = window.innerWidth * 0.60;
        let schaal = maxWidth / widthPX;
        
        const nieuweWidth = widthPX * schaal;
        const nieuweHeight = heightPX * schaal;
        
        svg.style.width = nieuweWidth + 'px';
        svg.style.height = nieuweHeight + 'px';
        svg.style.display = 'block';
        
        console.log('ðŸ“ Grootte:', Math.round(nieuweWidth), 'x', Math.round(nieuweHeight), 'px');
        
        // Positioneer gecentreerd
        graffitiY = window.innerHeight / 2;
        graffitiHoogte = nieuweHeight * 1.5;
        
        // Animeer na 1 seconde
        await new Promise(r => setTimeout(r, 1000));
        
        console.log('ðŸŽ¬ Start schrijven');
        
        let totalLength = paths.reduce((sum, p) => sum + p.length, 0);
        const schrijfDuur = 2500;
        let cumulativeLength = 0;
        let vorigePoint = null;
        
        paths.forEach(({ path, length }, idx) => {
            const startDelay = (cumulativeLength / totalLength) * schrijfDuur;
            const pathDuur = (length / totalLength) * schrijfDuur;
            cumulativeLength += length;
            
            setTimeout(() => {
                // Zet stroke
                path.setAttribute('stroke', kleur);
                path.setAttribute('stroke-width', '6');
                path.setAttribute('stroke-linecap', 'round');
                path.setAttribute('stroke-linejoin', 'round');
                path.setAttribute('fill', 'none');
                path.style.strokeDasharray = length;
                path.style.strokeDashoffset = length;
                
                const start = performance.now();
                
                function animate(now) {
                    const elapsed = now - start;
                    const t = Math.min(elapsed / pathDuur, 1);
                    
                    path.style.strokeDashoffset = length * (1 - t);
                    
                    // Spray effect
                    if (Math.random() < 0.5 && t < 0.95) {
                        try {
                            const point = path.getPointAtLength(length * t);
                            const containerRect = graffitiContainer.getBoundingClientRect();
                            
                            let angle = 0;
                            if (vorigePoint) {
                                const dx = point.x - vorigePoint.x;
                                const dy = point.y - vorigePoint.y;
                                angle = Math.atan2(dy, dx);
                            }
                            
                            for (let i = 0; i < 2; i++) {
                                maakSprayStreak(
                                    point.x + containerRect.left,
                                    point.y + containerRect.top,
                                    kleur,
                                    angle
                                );
                            }
                            
                            vorigePoint = point;
                        } catch (e) {}
                    }
                    
                    if (t < 1) {
                        requestAnimationFrame(animate);
                    } else if (idx === paths.length - 1) {
                        console.log('âœ… Schrijven klaar');
                        setTimeout(veegWeg, 2000); // Wacht 2 sec
                    }
                }
                requestAnimationFrame(animate);
            }, startDelay);
        });
        
    } catch (error) {
        console.error('âŒ FOUT:', error);
    }
}

function maakSprayStreak(x, y, kleur, richting) {
    const streak = document.createElement('div');
    streak.className = 'spray-streak';
    streak.style.left = x + 'px';
    streak.style.top = y + 'px';
    streak.style.backgroundColor = kleur;
    
    const spreadAngle = richting + (Math.random() - 0.5) * Math.PI / 3;
    const distance = 15 + Math.random() * 30;
    
    streak.style.setProperty('--tx', Math.cos(spreadAngle) * distance + 'px');
    streak.style.setProperty('--ty', Math.sin(spreadAngle) * distance + 'px');
    streak.style.transform = `rotate(${spreadAngle}rad)`;
    streak.style.animation = 'spray-streak 0.3s ease-out forwards';
    
    document.body.appendChild(streak);
    sprayParticles.push(streak);
    
    setTimeout(() => {
        streak.remove();
        sprayParticles = sprayParticles.filter(p => p !== streak);
    }, 300);
}

function veegWeg() {
    console.log('ðŸ§½ Start vegen');
    
    spons.style.display = 'block';
    wipeOverlay.style.display = 'block';

    const sponsSize = 96;
    let x = -sponsSize;
    const eindX = window.innerWidth + sponsSize;
    const snelheid = 8;

    function animeerSpons() {
        x += snelheid;
        
        spons.style.left = x + 'px';
        spons.style.top = (graffitiY - 48) + 'px';
        
        // Overlay groeit van links
        const overlayCenterX = x + (sponsSize / 2);
        wipeOverlay.style.left = '0';
        wipeOverlay.style.top = (graffitiY - graffitiHoogte / 2) + 'px';
        wipeOverlay.style.width = overlayCenterX + 'px';
        wipeOverlay.style.height = graffitiHoogte + 'px';
        
        if (x < eindX) {
            requestAnimationFrame(animeerSpons);
        } else {
            console.log('âœ… Vegen klaar');
            
            spons.style.display = 'none';
            wipeOverlay.style.display = 'none';
            graffitiContainer.innerHTML = '';
            
            sprayParticles.forEach(p => p.remove());
            sprayParticles = [];
            
            console.log('ðŸ”„ Klaar! Refresh de pagina om opnieuw te testen.');
        }
    }
    animeerSpons();
}

// Start test na 1 seconde
setTimeout(testGraffiti, 1000);
</script>

</body>
</html>
